{
  "name": "Cálculo Fiscal Automático - ContabilidadePRO",
  "nodes": [
    {
      "parameters": {
        "triggerMode": "listenTrigger",
        "channelName": "fiscal_calculation_completed"
      },
      "id": "postgres-trigger",
      "name": "Postgres Trigger - Cálculo Concluído",
      "type": "n8n-nodes-base.postgresTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "credentials": {
        "postgres": {
          "id": "supabase-contabilidadepro",
          "name": "Supabase ContabilidadePRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  cf.*,\n  e.nome as empresa_nome,\n  e.email as empresa_email,\n  e.cnpj as empresa_cnpj\nFROM calculos_fiscais cf\nJOIN empresas e ON cf.empresa_id = e.id\nWHERE cf.id = $1",
        "additionalFields": {
          "queryParameters": "={{ [$json.payload.id] }}"
        }
      },
      "id": "buscar-calculo",
      "name": "Buscar Detalhes do Cálculo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "supabase-contabilidadepro",
          "name": "Supabase ContabilidadePRO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "success-condition",
              "leftValue": "={{ $json.status }}",
              "rightValue": "concluido",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "verificar-status",
      "name": "Verificar Status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $('buscar-calculo').item(0).json.webhook_url || 'http://localhost:3000/api/webhooks/calculo-concluido' }}",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={\n  \"tipo\": \"calculo_fiscal_concluido\",\n  \"calculo_id\": \"{{ $json.id }}\",\n  \"empresa_id\": \"{{ $json.empresa_id }}\",\n  \"empresa_nome\": \"{{ $json.empresa_nome }}\",\n  \"tipo_calculo\": \"{{ $json.tipo_calculo }}\",\n  \"periodo_apuracao\": \"{{ $json.periodo_apuracao }}\",\n  \"valor_imposto\": {{ $json.resultado.valorImposto }},\n  \"data_vencimento\": \"{{ $json.resultado.dataVencimento }}\",\n  \"codigo_barras\": \"{{ $json.resultado.codigoBarras }}\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "autodetect"
            }
          },
          "timeout": 10000,
          "retry": {
            "retry": {
              "retryOnFail": true,
              "maxTries": 3,
              "waitBetweenTries": 2000
            }
          }
        }
      },
      "id": "notificar-aplicacao",
      "name": "Notificar Aplicação",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/api/queue/enqueue",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={\n  \"queueName\": \"notificacoes\",\n  \"jobData\": {\n    \"type\": \"notificacao\",\n    \"tipo\": \"email\",\n    \"destinatario\": \"{{ $json.empresa_email }}\",\n    \"template\": \"calculo_concluido\",\n    \"dados\": {\n      \"empresa_nome\": \"{{ $json.empresa_nome }}\",\n      \"tipo_calculo\": \"{{ $json.tipo_calculo }}\",\n      \"periodo\": \"{{ $json.periodo_apuracao }}\",\n      \"valor\": \"{{ $json.resultado.valorImposto }}\",\n      \"data_vencimento\": \"{{ $json.resultado.dataVencimento }}\",\n      \"codigo_barras\": \"{{ $json.resultado.codigoBarras }}\"\n    },\n    \"timestamp\": \"{{ new Date().toISOString() }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "retry": {
            "retry": {
              "retryOnFail": true,
              "maxTries": 2
            }
          }
        }
      },
      "id": "enfileirar-email",
      "name": "Enfileirar Email de Notificação",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agenda_fiscal (empresa_id, tipo_evento, data_evento, valor, status, detalhes)\nVALUES ($1, $2, $3, $4, 'pendente', $5)",
        "additionalFields": {
          "queryParameters": "=[\n  \"{{ $json.empresa_id }}\",\n  \"Vencimento {{ $json.tipo_calculo }}\",\n  \"{{ $json.resultado.dataVencimento }}\",\n  {{ $json.resultado.valorImposto }},\n  {\n    \"calculo_id\": \"{{ $json.id }}\",\n    \"codigo_barras\": \"{{ $json.resultado.codigoBarras }}\",\n    \"periodo_apuracao\": \"{{ $json.periodo_apuracao }}\"\n  }\n]"
        }
      },
      "id": "agendar-vencimento",
      "name": "Agendar Vencimento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [900, 400],
      "credentials": {
        "postgres": {
          "id": "supabase-contabilidadepro",
          "name": "Supabase ContabilidadePRO"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/api/queue/enqueue",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={\n  \"queueName\": \"geracao_relatorios\",\n  \"jobData\": {\n    \"type\": \"gerar_relatorio\",\n    \"tipo_relatorio\": \"guia_pagamento\",\n    \"calculo_id\": \"{{ $json.id }}\",\n    \"empresa_id\": \"{{ $json.empresa_id }}\",\n    \"dados\": {\n      \"empresa_nome\": \"{{ $json.empresa_nome }}\",\n      \"cnpj\": \"{{ $json.empresa_cnpj }}\",\n      \"tipo_calculo\": \"{{ $json.tipo_calculo }}\",\n      \"periodo\": \"{{ $json.periodo_apuracao }}\",\n      \"valor\": {{ $json.resultado.valorImposto }},\n      \"data_vencimento\": \"{{ $json.resultado.dataVencimento }}\",\n      \"codigo_barras\": \"{{ $json.resultado.codigoBarras }}\",\n      \"detalhes_calculo\": {{ JSON.stringify($json.resultado.detalhesCalculo) }}\n    },\n    \"timestamp\": \"{{ new Date().toISOString() }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "retry": {
            "retry": {
              "retryOnFail": true,
              "maxTries": 2
            }
          }
        }
      },
      "id": "gerar-guia",
      "name": "Gerar Guia de Pagamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO logs_automacao (workflow_name, execution_id, empresa_id, acao, status, detalhes, timestamp)\nVALUES ($1, $2, $3, $4, $5, $6, NOW())",
        "additionalFields": {
          "queryParameters": "=[\n  \"calculo-fiscal-automatico\",\n  \"{{ $workflow.id }}\",\n  \"{{ $json.empresa_id }}\",\n  \"processamento_completo\",\n  \"sucesso\",\n  {\n    \"calculo_id\": \"{{ $json.id }}\",\n    \"tipo_calculo\": \"{{ $json.tipo_calculo }}\",\n    \"valor_calculado\": {{ $json.resultado.valorImposto }},\n    \"acoes_executadas\": [\"notificacao_app\", \"email_enviado\", \"vencimento_agendado\", \"guia_gerada\"]\n  }\n]"
        }
      },
      "id": "log-sucesso",
      "name": "Log de Sucesso",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1120, 350],
      "credentials": {
        "postgres": {
          "id": "supabase-contabilidadepro",
          "name": "Supabase ContabilidadePRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO logs_automacao (workflow_name, execution_id, empresa_id, acao, status, detalhes, timestamp)\nVALUES ($1, $2, $3, $4, $5, $6, NOW())",
        "additionalFields": {
          "queryParameters": "=[\n  \"calculo-fiscal-automatico\",\n  \"{{ $workflow.id }}\",\n  \"{{ $json.empresa_id }}\",\n  \"calculo_com_erro\",\n  \"erro\",\n  {\n    \"calculo_id\": \"{{ $json.id }}\",\n    \"status_calculo\": \"{{ $json.status }}\",\n    \"erro_detalhes\": \"{{ $json.erro_detalhes }}\",\n    \"timestamp_erro\": \"{{ $json.processado_em }}\"\n  }\n]"
        }
      },
      "id": "log-erro",
      "name": "Log de Erro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 500],
      "credentials": {
        "postgres": {
          "id": "supabase-contabilidadepro",
          "name": "Supabase ContabilidadePRO"
        }
      }
    }
  ],
  "connections": {
    "Postgres Trigger - Cálculo Concluído": {
      "main": [
        [
          {
            "node": "Buscar Detalhes do Cálculo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Detalhes do Cálculo": {
      "main": [
        [
          {
            "node": "Verificar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Status": {
      "main": [
        [
          {
            "node": "Notificar Aplicação",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enfileirar Email de Notificação",
            "type": "main",
            "index": 0
          },
          {
            "node": "Agendar Vencimento",
            "type": "main",
            "index": 0
          },
          {
            "node": "Gerar Guia de Pagamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log de Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar Aplicação": {
      "main": [
        [
          {
            "node": "Log de Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar Email de Notificação": {
      "main": [
        [
          {
            "node": "Log de Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agendar Vencimento": {
      "main": [
        [
          {
            "node": "Log de Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Guia de Pagamento": {
      "main": [
        [
          {
            "node": "Log de Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-01-19T10:30:00.000Z",
      "updatedAt": "2025-01-19T10:30:00.000Z",
      "id": "fiscal-automation",
      "name": "Automação Fiscal"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-01-19T10:30:00.000Z",
  "versionId": "1"
}
